name: Run keyword_kz bi-weekly

on:
  schedule:
    - cron: '0 3 * * 1'    # –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 03:00 UTC
  workflow_dispatch:       # –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  biweekly:
    runs-on: ubuntu-latest

    steps:
      - name: Decision Step
        id: check
        shell: bash
        run: |
          # 1. –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ —ç—Ç–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ ‚Äî —Å—Ä–∞–∑—É —Ä–∞–∑—Ä–µ—à–∞–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º.
          # –ù–∏–∫–∞–∫–æ–π –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, –Ω–∏–∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫.
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "üîµ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫: –†–ê–ó–†–ï–®–ê–ï–ú."
             echo "should_run=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # 2. –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å, –∑–Ω–∞—á–∏—Ç –∑–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é. –°—á–∏—Ç–∞–µ–º –Ω–µ–¥–µ–ª—é.
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º python –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, —á—Ç–æ–±—ã bash –Ω–µ —Ä—É–≥–∞–ª—Å—è –Ω–∞ —Ü–∏—Ñ—Ä—ã.
          python3 -c "import datetime; w = datetime.date.today().isocalendar()[1]; print(f'Week: {w}'); print('should_run=true') if w % 2 != 0 else print('should_run=false')" >> $GITHUB_OUTPUT

      - name: Checkout code
        # –≠—Ç–æ—Ç —à–∞–≥ (–∏ —Å–ª–µ–¥—É—é—â–∏–µ) —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ should_run = true
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v3

      - name: Set up Python
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        if: steps.check.outputs.should_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write Google creds
        if: steps.check.outputs.should_run == 'true'
        run: |
          cat << 'EOF' > level-landing-195008-a8940ac6b2ab.json
          ${{ secrets.GCP_CREDENTIALS }}
          EOF

      - name: Run keyword_kz
        if: steps.check.outputs.should_run == 'true'
        env:
          TOKEN: ${{ secrets.KEYWORD_API_TOKEN }}
        run: python keyword_kz.py
